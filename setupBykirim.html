<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Setup - By Kirim</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

<style>
body { 
    background-color: #f8f9fa; 
    max-width: 500px;
}
.table-hover tbody tr:hover { 
    background-color: #f2f2f2; 
    cursor: pointer; 
}
.actions-col { 
    width: 100px; 
    text-align: center; 
    white-space: nowrap; 
}

/************************/
/* Pengaturan Icon-icon */
/************************/
/* Default semua icon (enabled & disabled) tidak terlihat */
.action-icon {
    display: inline-flex;
    justify-content: center;
    align-items: center;
    width: 25px;
    height: 25px;
    opacity: 0;
    transition: opacity 0.2s, color 0.2s, background-color 0.2s;
    margin: 0 5px;
    cursor: pointer;
    color: #6c757d;
    border-radius: 50%;
    padding: 4px;
    font-size: 15px;
}

/* Saat hover ke baris, semua icon disabled akan muncul */
tr:hover .action-icon {
    opacity: 1;
}
/* Hover efek untuk ikon aktif */
.action-icon:hover {
    color: red;
    background-color: #e0e0e0;
}
/* Disabled icon â€“ tidak bisa diklik dan tidak bereaksi saat hover */
.action-icon.disabled {
    pointer-events: none;
    color: #bbb !important;
    background-color: transparent !important;
}

.sticky-header th { 
    position: sticky; 
    top: 0; 
    background-color: #003366; 
    color: white; 
    z-index: 2; 
    font-size:15px;
}
.title-box { 
    background-color: #003366; 
    color: white; 
    padding: 10px 15px; 
    border-radius: 5px; 
    display: flex; 
    align-items: center; 
    box-shadow: 0 2px 6px rgba(0,0,0,0.2); 
}
.title-box i { margin-right: 10px; }
.button-box {
    background: white;
    border-radius: 5px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    padding: 10px;
    margin: 15px 0;
}

.table-box {
    position: relative;
    background: white;
    border-radius: 5px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    padding: 10px;
}
.table-wrapper { 
    max-height: 450px; 
    overflow-y: auto;  /* Scrolls vertikal */
}
/* Menjaga sel pindah baris */
.table th, .table td {
   white-space: nowrap;
}

/* Notifikasi Message Box */
.notification-message {
    padding: 8px 12px;
    border-radius: 4px;
    margin-bottom: 12px;
    font-size: 14px;
    display: none;
    align-items: center;
    gap: 10px; /* agar icon dan teks tidak dempet */
}
.pesan-notif-icon {font-size: 18px;}
.notification-error { background-color: #d9534f; color: white; }
.notification-success { background-color: #0275d8; color: white; }
.notification-warning { background-color: #f0ad4e; color: black; }

/* Spinner Untuk tabel */
.loading-overlay {
  position: absolute;
  top: 100px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
}

/****************************/
/* Tampilan Vertikal Mobile */
/****************************/
@media (max-width: 491.98px) {
    .sticky-header th tr { 
       font-size:15px;
       white-space: nowrap !important;
    }
    /* Membuat tabel bisa discroll horizontal di layar kecil */
    .table-wrapper {
    max-width: 100%;
    overflow-x: auto;
    }
    /* Menjaga sel tidak pndah baris */
    .table th, .table td {
    white-space: nowrap;
    }
    .btn-group-vertical-responsive {
       flex-direction: column !important;
       align-items: stretch !important;
       gap: 6px; /* jarak antar tombol */
    }
    .btn-group-vertical-responsive button,
    .btn-group-vertical-responsive a {
       width: 100% !important;
       text-align: left;
    }
}
</style>
</head>

<body class="p-2 p-sm-3">
<div class="container">
<div class="title-box mb-3">
    <i class="fas fa-shipping-fast"></i>
    <h6 class="mb-0">SETUP BIAYA PENGIRIMAN</h6>
</div>

<!-- Tombol Form Setup biaya kirim -->
<div class="button-box d-flex justify-content-between align-items-center">
    <div>
      <button class="btn btn-primary btn-sm mb-1" id="addByKirimButton"><i class="fas fa-plus-square"></i> Tambah</button>
    </div>
    <div>
       <a href="setupEstih.html" class="btn btn-secondary btn-sm mb-1"><i class="fas fa-sign-out-alt"></i> Kembali</a>
    </div>
</div>

<!-- Notifikasi Pesan -->
<div id="pesanNotification" class="notification-message w-100 mb-2" style="display: none;">
    <i id="pesanNotifIcon" class="pesan-notif-icon"></i><span id="pesanNotifText"></span>
</div>

   <!-- Tabel Daftar Biaya Kirim -->
    <div class="table-box">
        <!-- Loading Overlay -->
        <div id="loadingOverlayByKirim" class="loading-overlay" style="display: none;">
          <div class="spinner-border text-primary" role="status" aria-hidden="true"></div>
          <span class="visually-hidden">Memuat Data...</span>
        </div>
        
        <div class="table-wrapper">
        <table class="table table-hover table-striped table-bordered align-middle" style="table-layout:auto; width:auto;">
            <thead class="sticky-header text-center"><h6 class="mb-2">Daftar Biaya Pengiriman</h6>
                <tr>
                    <th>No</th>
                    <th>Jenis Pengiriman</th>
                    <th>Biaya</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody id="byKirimTableBody" style="font-size: small; align-content: center;">
                <!-- Data akan diisi oleh JavaScript di sini -->  
            </tbody>
        </table>
        </div>
    </div>
</div>

<!-- Modal Add/Edit -->
<div class="modal fade" id="modalByKirim" tabindex="-1" data-mode="add">
<div class="modal-dialog">
<form id="byKirimForm" class="modal-content">
    <div class="modal-header" style="background-color:#003366; color:white;">
        <h6 id="judulModal" class="modal-title">Tambah Biaya Pengiriman</h6>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
        <input type="hidden" id="mode" value="add"> 
        <input type="hidden" id="rowId" value="">
        
        <div class="input-group mb-2">
            <span class="input-group-text">JP</span>
            <input type="text" id="jenisPengiriman" class="form-control" placeholder="Masukkan jenis pengiriman (wajib isi)" maxlength="50" required>
        </div>
        <div class="input-group mb-2">
            <span class="input-group-text">BY</span>
            <input type="text" inputmode="decimal" pattern="[0-9.,]*" id="biaya" class="form-control" placeholder="Masukkan biaya (wajib isi)" required>
        </div>
    </div>

    <div class="modal-footer flex-column align-items-start">
        <!-- Notifikasi Pesan -->
        <div id="pesanNotifModalBox" class="notification-message w-100 mb-2" style="display: none;">
           <i id="pesanNotifModalIcon" class="pesan-notif-icon me-2"></i><span id="pesanNotifModalText"></span>
        </div>
        <!-- Tombol-tombol untuk Modal Add dan Edit -->
        <div class="w-100 d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-primary btn-sm" id="btnSimpanByKirim"><i class="fas fa-save"></i> Simpan</button>
            <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal"><i class="fas fa-close"></i> Batal</button>
        </div>
    </div>
</form>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<SCRIPT>
// ********* Deklarasi Public **********
const URL_APPS_SCRIPT = 'https://script.google.com/macros/s/AKfycbzxXyV5FMCWUXXj1eWmWKgObLkJX7yhfwIyWIAZBErFp4SpFRjWIl9YPqeQGh4QuS3L1A/exec';
// **************************************

// **********************************
// Tampilkan Spinner Loading Overlay
// **********************************
function showLoading(show, target = 'ByKirim') {
  const overlayId = 'loadingOverlayByKirim';
  let overlay = document.getElementById(overlayId);
  if (overlay) overlay.style.display = show ? 'flex' : 'none';
}

// ***************************************************************
// Tambahkan sebelum loadByKirimTable Untuk menghindari error atau 
// tampilan karakter khusus di data dari sheet
// ***************************************************************
function escapeHtml(text) {
  if (text === null || text === undefined) return '';
  return String(text)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/'/g, '&#39;')
    .replace(/"/g, '&quot;');
}

// *******************************************
// Pesan Notifikasi untuk di Form Tabel ByKirim
// *******************************************
function showPesan(type, message, duration = 3000) {
  const box      = document.getElementById('pesanNotification');
  const icon     = document.getElementById('pesanNotifIcon');
  const text     = document.getElementById('pesanNotifText');

  // Reset class
  box.className  = 'notification-message';
  icon.className = 'pesan-notif-icon';

  if (type === 'error') {
    box.classList.add('notification-error');
    icon.classList.add('fas', 'fa-times-circle');
  } else if (type === 'success') {
    box.classList.add('notification-success');
    icon.classList.add('fas', 'fa-check-circle');
  } else if (type === 'warning') {
    box.classList.add('notification-warning');
    icon.classList.add('fas', 'fa-exclamation-circle');
  }
  text.textContent  = message;
  box.style.display = 'flex';
  setTimeout(() => {box.style.display = 'none';}, duration);
}

// **************************************************
// Pesan Notifikasi untuk di Form Modal Add dan Edit
// **************************************************
function showPesanModal(type, message, duration = 3000) {
  const boxModal  = document.getElementById('pesanNotifModalBox');
  const iconModal = document.getElementById('pesanNotifModalIcon');
  const textModal = document.getElementById('pesanNotifModalText');

  // Reset class
  boxModal.className  = 'notification-message w-100 mb-2';
  iconModal.className = 'pesan-notif-icon me-2';

  if (type === 'error') {
    boxModal.classList.add('notification-error');
    iconModal.classList.add('fas', 'fa-times-circle');
  } else if (type === 'success') {
    boxModal.classList.add('notification-success');
    iconModal.classList.add('fas', 'fa-check-circle');
  } else if (type === 'warning') {
    boxModal.classList.add('notification-warning');
    iconModal.classList.add('fas', 'fa-exclamation-circle');
  }

  textModal.textContent  = message;
  boxModal.style.display = 'flex';
  setTimeout(() => {
    boxModal.style.display = 'none';
  }, duration);
}

// *************************************************
// Format angka sesuai lokal Indonesia (selalu 2 desimal
// *************************************************
function formatAngka(value) {
  if (value === null || value === undefined || value === '') return '';
  
  let num;
  if (typeof value === 'number') {
    num = value;
  } else {
    let s = value.toString().trim();
    // untuk harga: hapus titik ribuan lalu ganti koma dengan titik
    s = s.replace(/\./g, '').replace(',', '.');
    num = parseFloat(s);
  }

  if (isNaN(num)) return '';
  
  return new Intl.NumberFormat("id-ID", {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  }).format(num);
}

// *************************************************
// Fungsi untuk ubah formatted string (2.123.700,12) 
// menjadi angka untuk dikirim ke server
// *************************************************
function unformatNumber(formatted) {
  if (formatted === null || formatted === undefined) return '';
  let s = String(formatted).trim();
  if (s === '') return '';
  // Harga: "2.123.700,12" -> "2123700.12"
  s = s.replace(/\./g, '').replace(',', '.').replace(/\s/g, '');
  return s;
}

// **************************************************************
// auto-format saat input (menulis titik ribuan dan koma desimal)
// **************************************************************
function formatInputCurrency(input) {
  const raw     = (input.value || '').replace(/[^0-9,]/g, ''); // hanya angka & koma
  let parts     = raw.split(',');
  let integer   = parts[0].replace(/^0+/, '') || '0';
  let formatted = integer.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
  if (parts.length > 1) {
    formatted += ',' + parts[1].slice(0, 2); // max 2 desimal
  }
  input.value = formatted;
  // letakkan kursor di akhir (sederhana & stabil)
  input.setSelectionRange(formatted.length, formatted.length);
}

// ************************************
// Fungsi untuk memanggil Tabel ByKirim 
// ************************************
function loadByKirimTable() {
  showLoading(true, 'ByKirim');
  const callbackName = 'cb_' + Date.now();
  const script = document.createElement('script');
  script.src = `${URL_APPS_SCRIPT}?action=getTabelByKirim&callback=${callbackName}`;

  window[callbackName] = function (data) {
    const tbody = document.getElementById('byKirimTableBody');
    tbody.innerHTML = '';

    if (!data || data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" class="text-center">Tidak ada data biaya pengiriman.</td></tr>';
      cleanup();
      showLoading(false, 'ByKirim');
      return;
    }

    data.forEach((row, index) => {
      while (row.length < 2) row.push('');

      const [jenisPengiriman, biaya] = row;

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="text-center">${index + 1}</td>
        <td class="text-start">${escapeHtml(jenisPengiriman)}</td>
        <td class="text-end">${formatAngka(biaya)}</td>
        <td class="actions-col text-center">
          <i class="fas fa-edit action-icon" title="Edit Biaya Pengiriman"
            onclick="showEditModal(${index}, '${escapeHtml(jenisPengiriman)}', '${biaya}')"></i>
          <i class="fas fa-trash-alt action-icon" title="Hapus Biaya Pengiriman" 
            onclick="deleteByKirim(${index}, '${escapeHtml(jenisPengiriman)}')"></i>
        </td>
      `;
      tbody.appendChild(tr);
    });

    cleanup();
    showLoading(false, 'ByKirim');
  };

  script.onerror = function () {
    showPesan('error', ' ERROR : Gagal mengambil data Biaya Pengiriman!');
    cleanup();
    showLoading(false, 'ByKirim');
  };

  function cleanup() {
    try { delete window[callbackName]; } catch (e) {}
    document.body.removeChild(script);
  }

  document.body.appendChild(script);
}

// ***************************
// Tampilkan Modal Edit ByKirim
// *************************** 
function showEditModal(rowIndex, jenisPengiriman, biaya) {
  const modal = document.getElementById("modalByKirim");
  const form = document.getElementById("byKirimForm");
  if (!modal || !form) return;

  // Set mode edit
  modal.setAttribute("data-mode", "edit");
  document.getElementById('judulModal').textContent = 'Edit Biaya Pengiriman';
  document.getElementById('rowId').value = rowIndex;
  document.getElementById('jenisPengiriman').value = jenisPengiriman || "";
  document.getElementById('biaya').value = formatAngka(biaya);

  new bootstrap.Modal(modal).show();
}

// *********************
// Validasi Form ByKirim
// ********************* 
function validateByKirimForm() {
  const jenisPengiriman = document.getElementById('jenisPengiriman').value.trim();
  const biaya = document.getElementById('biaya').value.trim();

  // Validasi field wajib (tidak boleh kosong)
  if (!jenisPengiriman) {
    showPesanModal("warning", " WARNING : Field Jenis Pengiriman wajib diisi.");
    return false;
  }

  // Unformat angka sebelum validasi
  const biayaRaw = unformatNumber(biaya);

  if (biayaRaw === '' || isNaN(biayaRaw)) {
    showPesanModal("warning", " WARNING : Field Biaya harus berisi angka.");
    return false;
  }

  return true; // Semua valid
}

// ****************************
// Fungsi untuk menambah ByKirim
// ****************************
function addByKirim() {
  // Ambil data input
  const jenisPengiriman = document.getElementById('jenisPengiriman').value.trim();
  const biaya = document.getElementById('biaya').value.trim();

  // Validasi form
  if (!validateByKirimForm()) return;

  // Konversi angka ke format kirim (hilangkan titik ribuan, pakai . sebagai desimal)
  const biayaRaw = unformatNumber(biaya);

  const callbackName = 'cb_' + Date.now();

  window[callbackName] = function(response) {
    console.log("Respon server addByKirim:", response);
    if (response && (response.status === 'success' || response.success === true)) {
      showPesanModal("success", " SUKSES : " + (response.message || 'Biaya pengiriman berhasil ditambahkan'));
      const modalEl = document.getElementById("modalByKirim");
      bootstrap.Modal.getInstance(modalEl)?.hide();
      loadByKirimTable();
    } else {
      showPesanModal("error", " ERROR : " + (response?.message || 'Gagal menambahkan biaya pengiriman'));
    }
    cleanup();
  };

  const params = new URLSearchParams({
    action: 'addByKirim',
    jenisPengiriman,
    biaya: biayaRaw,
    callback: callbackName
  });

  console.log("addByKirim -> data dikirim:", Object.fromEntries(params.entries()));

  const script = document.createElement('script');
  script.id    = callbackName + '_script';
  script.src   = `${URL_APPS_SCRIPT}?${params.toString()}`;
  document.body.appendChild(script);

  function cleanup() {
    try { delete window[callbackName]; } catch(e){}
    document.getElementById(callbackName + '_script')?.remove();
  }
}

// *******************************
// Fungsi untuk mengedit ByKirim
// *******************************
function editByKirim() {
  // Ambil data input
  const rowIndex = document.getElementById('rowId').value;
  const jenisPengiriman = document.getElementById('jenisPengiriman').value.trim();
  const biaya = document.getElementById('biaya').value.trim();

  // Validasi form
  if (!validateByKirimForm()) return;

  // Konversi angka
  const biayaRaw = unformatNumber(biaya);

  const callbackName = 'cb_' + Date.now();

  window[callbackName] = function(response) {
    console.log("Respon server editByKirim:", response);
    if (response && (response.status === 'success' || response.success === true)) {
      showPesanModal("success", " SUKSES : " + (response.message || 'Biaya pengiriman berhasil diupdate'));
      const modalEl = document.getElementById("modalByKirim");
      bootstrap.Modal.getInstance(modalEl)?.hide();
      document.getElementById("modalByKirim").setAttribute("data-mode", "add");
      loadByKirimTable();
    } else {
      showPesanModal("error", " ERROR : " + (response?.message || 'Gagal mengupdate biaya pengiriman'));
    }
    cleanup();
  };

  const params = new URLSearchParams({
    action: 'editByKirim',
    rowIndex,
    jenisPengiriman,
    biaya: biayaRaw,
    callback: callbackName
  });

  console.log("editByKirim -> data dikirim:", Object.fromEntries(params.entries()));

  const script = document.createElement('script');
  script.id = callbackName + '_script';
  script.src = `${URL_APPS_SCRIPT}?${params.toString()}`;
  document.body.appendChild(script);

  function cleanup() {
    try { delete window[callbackName]; } catch(e){}
    document.getElementById(callbackName + '_script')?.remove();
  }
}

// ********************************
// Fungsi untuk menghapus ByKirim
// ********************************
function deleteByKirim(rowIndex, jenisPengiriman) {
  if (!confirm(`Yakin ingin menghapus biaya pengiriman "${jenisPengiriman}"?`)) return;

  const callback = 'cb_' + Date.now();
  window[callback] = function(response) {
    if (response.status === 'success') {
       showPesan('success', " SUKSES : " + response.message);
       loadByKirimTable(); // Refresh tabel
    } else {
       showPesan('error', " ERROR : " + (response.message || 'Gagal menghapus data'));
    }
    delete window[callback];
  };

  const script = document.createElement('script');
  script.src = `${URL_APPS_SCRIPT}?action=deleteByKirim&rowIndex=${encodeURIComponent(rowIndex)}&callback=${callback}`;
  document.body.appendChild(script);
}

// **********************************************************************************
//  Fungsi Event untuk load Tabel ByKirim, tombol-tombol serta event lainnya
// **********************************************************************************
document.addEventListener('DOMContentLoaded', () => {
  // --- Load tabel awal
  loadByKirimTable();

  // --- Event tombol Tambah ByKirim
  const addBtn = document.getElementById('addByKirimButton');
  if (addBtn) {
    addBtn.addEventListener('click', () => {
      document.getElementById('mode').value = 'add';
      document.getElementById('modalByKirim').setAttribute('data-mode', 'add');
      document.getElementById('byKirimForm').reset();
      document.getElementById('judulModal').textContent = 'Tambah Biaya Pengiriman';
      new bootstrap.Modal(document.getElementById('modalByKirim')).show();
    });
  }

  // --- Event tombol Simpan ByKirim
  const btnSimpan = document.getElementById('btnSimpanByKirim');
  if (btnSimpan) {
    btnSimpan.addEventListener('click', () => {
      const mode = document.getElementById('modalByKirim').getAttribute('data-mode') || 'add';
      if (mode === 'edit') editByKirim();
      else addByKirim();
    });
  }

  // --- Auto-format angka saat input
  const biayaField = document.getElementById('biaya');
  if (biayaField) biayaField.addEventListener('input', () => formatInputCurrency(biayaField));
});

</SCRIPT>
</body>
</html>