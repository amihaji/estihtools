<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Setup - Estih Tools</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

<style>
body { 
    background-color: #f8f9fa; 
}
.table-hover tbody tr:hover { 
    background-color: #f2f2f2; 
    cursor: pointer; 
}
.actions-col { 
    width: 220px; 
    text-align: center; 
    white-space: nowrap; 
}

/************************/
/* Pengaturan Icon-icon */
/************************/
/* Default semua icon (enabled & disabled) tidak terlihat */
/* Ikon default (hidden) */
.action-icon {
    display: inline-flex;
    justify-content: center;
    align-items: center;
    width: 25px;
    height: 25px;
    opacity: 0;
    transition: opacity 0.2s, color 0.2s, background-color 0.2s;
    margin: 0 5px;
    cursor: pointer;
    color: #6c757d;
    border-radius: 50%;
    padding: 4px;
    font-size: 15px;
}

/* Saat hover ke baris, semua icon disabled akan muncul */
tr:hover .action-icon {
    opacity: 1;
}
/* Hover efek untuk ikon aktif */
.action-icon:hover {
    color: red;
    background-color: #e0e0e0;
}
/* Disabled icon â€“ tidak bisa diklik dan tidak bereaksi saat hover */
.action-icon.disabled {
    pointer-events: none;
    color: #bbb !important;
    background-color: transparent !important;
}

.sticky-header th { 
    position: sticky; 
    top: 0; 
    background-color: #003366; 
    color: white; 
    z-index: 2; 
    font-size:15px;
}
.title-box { 
    background-color: #003366; 
    color: white; 
    padding: 10px 15px; 
    border-radius: 5px; 
    display: flex; 
    align-items: center; 
    box-shadow: 0 2px 6px rgba(0,0,0,0.2); 
}
.title-box i { margin-right: 10px; }
.button-box { 
    background: white; 
    border-radius: 5px; 
    box-shadow: 0 2px 6px rgba(0,0,0,0.1); 
    padding: 10px; 
    margin: 15px 0; 
}
.btn-group-vertical-responsive { 
    display: flex; 
    flex-direction: row; 
    gap: 10px; 
}

.table-box { 
    background: white; 
    border-radius: 5px; 
    box-shadow: 0 2px 6px rgba(0,0,0,0.1); 
    padding: 10px; 
}
.table-wrapper { 
    max-height: 450px; 
    overflow-y: auto; 
}

/* Notifikasi Message Box */
.notification-message {
    padding: 8px 12px;
    border-radius: 4px;
    margin-bottom: 12px;
    font-size: 14px;
    display: none;
    align-items: center;
    gap: 10px; /* agar icon dan teks tidak dempet */
}
.pesan-notif-icon {font-size: 18px;}
.notification-error { background-color: #d9534f; color: white; }
.notification-success { background-color: #0275d8; color: white; }
.notification-warning { background-color: #f0ad4e; color: black; }

/* Spinner Untuk tabel produk */
.loading-overlay {
  position: absolute;
  top: 100px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 9999;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Hak Akses */
.hak-akses-group {
  display: flex;
  flex-wrap: wrap;
  margin-top: 5px;
}
.hak-akses-item {
  display: flex;
  align-items: center;
  padding-right: 60px;
  padding-left: 3px;
}
.hak-akses-item label {
  margin-left: 10px;
  min-width: 75px;
}

/****************************/
/* Tampilan Vertikal Mobile */
/****************************/
@media (max-width: 591.98px) {
    .sticky-header th tr { 
       font-size:15px;
       white-space: nowrap !important;
    }
    /* Membuat tabel bisa discroll horizontal di layar kecil */
    .table-wrapper {
    max-width: 100%;
    overflow-x: auto;
    }
    /* Menjaga sel tidak membungkus isi */
    .table th, .table td {
    white-space: nowrap;
    }
    .btn-group-vertical-responsive {
       flex-direction: column !important;
       align-items: stretch !important;
       gap: 6px; /* jarak antar tombol */
    }
    .btn-group-vertical-responsive button,
    .btn-group-vertical-responsive a {
       width: 100% !important;
       text-align: center;
    }
}
</style>
</head>

<body class="p-2 p-sm-3">
<div class="container">
<div class="title-box mb-3">
    <i class="fas fa-cog"></i>
    <h6 class="mb-0">SETUP ESTIHTOOLS</h6>
</div>

<!-- Tombol Form Setup produk -->
<div class="button-box d-flex justify-content-between align-items-center btn-group-vertical-responsive">
    <div>
       <button class="btn btn-primary btn-sm mb-1" id="addProdukButton"><i class="fas fa-plus-square"></i> Produk</button>
       <button class="btn btn-primary btn-sm mb-1" id="addKategoriButton"><i class="far fa-list-alt"></i> Kategori</button>
       <button class="btn btn-primary btn-sm mb-1" id="addByKirimButton"><i class="fas fa-shipping-fast"></i> By Kirim</button>
       <button class="btn btn-primary btn-sm mb-1" id="addImportProduk"><i class="fas fa-file-import"></i> Import </button>
       <!-- <button class="btn btn-primary btn-sm mb-1" onclick="showLogNotifForm()"><i class="fas fa-list"></i> Log Notif</button>-->
    </div>
    <div>
       <a href="https://amihaji.github.io/kitworks/index.html" class="btn btn-secondary btn-sm mb-1"><i class="fas fa-sign-out-alt"></i> Kembali</a>
    </div>
</div>

<!-- Notifikasi Pesan -->
<div id="pesanNotification" class="notification-message">
    <i id="pesanNotifIcon" class="pesan-notif-icon"></i><span id="pesanNotifText"></span>
</div>
    <!-- Tabel Daftar Produk -->
    <div class="table-box">
        <div class="table-wrapper">
        <table class="table table-hover table-striped table-bordered align-middle text-center" style="table-layout:auto; width:auto;">
            <thead class="sticky-header"><h6 class="mb-2">Daftar Harga Produk</h6>
                <tr>
                    <th>No Stok</th>
                    <th>Kategori</th>
                    <th>Nama Produk</th>
                    <th>VP</th>
                    <th>Harga Dasar</th>
                    <th>Harga Eceran</th>
                    <th>Member 25</th>
                    <th>SC 35</th>
                    <th>SB 42</th>
                    <th>SPV 50</th>
                    <th class="actions-col">Aksi</th>
                </tr>
            </thead>
            <!-- Loading Overlay -->
            <div id="loadingOverlayproduk" class="loading-overlay" style="display:none; align-content: center;">
               <div class="spinner-border text-primary" role="status"></div>
            </div>   
            <tbody id="produkTableBody" style="font-size: small;"><tr><td colspan="15">Memuat data produk ...</td></tr>
               <!-- Data akan diisi oleh JavaScript di sini -->  
            </tbody>
        </table>
        </div>
    </div>
</div>

<!-- Modal Add/Edit -->
<div class="modal fade" id="modalProduk" tabindex="-1" data-mode="add">
<div class="modal-dialog">
<form id="produkForm" class="modal-content">
    <div class="modal-header" style="background-color:#003366; color:white;">
        <h6 id="judulModal" class="modal-title">Tambah Produk</h6>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
        <input type="hidden" id="mode" value="add">
        <div class="mb-2"><label>Produk ID</label><input type="text" id="noStok" class="form-control" required></div>
        <div class="mb-2"><label>Nama Produk</label><input type="text" id="ProdukName" class="form-control" required></div>
        <div class="mb-2"><label>Email</label><input type="email" id="ProdukEmail" class="form-control" required></div>
        <div class="mb-2"><label>HP</label><input type="text" id="ProdukHP" class="form-control" required></div>
        <div class="mb-2"><label>Password</label><input type="text" id="ProdukPass" class="form-control" required></div>
        <div class="mb-2"><label>Level</label>
            <select id="ProdukLevel" class="form-select" required>
                <option value="Admin">Admin</option>
                <option value="Member">Member</option>
                <option value="Produk">Produk</option>
            </select>
        </div>
        <div class="mb-2"><label>Salah</label><input type="number" id="ProdukSalah" class="form-control" value="0" min="0" max="3" required></div>
        <div class="form-group">
            <label>Hak Akses, pilih (Y/N):</label>
            <div class="hak-akses-group">
                <div class="hak-akses-item">
                <label>1. Login :</label>
                    <label><input type="radio" name="aksesLogin" value="Y" checked> Yes</label>
                    <label><input type="radio" name="aksesLogin" value="N"> No</label>
                </div>
                <div class="hak-akses-item">
                <label>2. Setting :</label>
                    <label><input type="radio" name="aksesSetting" value="Y" checked> Yes</label>
                    <label><input type="radio" name="aksesSetting" value="N"> No</label>
                </div>
                <div class="hak-akses-item">
                <label>3. FLC :</label>
                    <label><input type="radio" name="aksesFLC" value="Y" checked> Yes</label>
                    <label><input type="radio" name="aksesFLC" value="N"> No</label>
                </div>
                <div class="hak-akses-item">
                <label>4. EstiH :</label>
                    <label><input type="radio" name="aksesEstiH" value="Y" checked> Yes</label>
                    <label><input type="radio" name="aksesEstiH" value="N"> No</label>
                </div>
                <div class="hak-akses-item">
                <label>5. WE :</label>
                    <label><input type="radio" name="aksesWE" value="Y" checked> Yes</label>
                    <label><input type="radio" name="aksesWE" value="N"> No</label>
                </div>
                <div class="hak-akses-item">
                <label>6. Follow :</label>
                    <label><input type="radio" name="aksesFollow" value="Y" checked> Yes</label>
                    <label><input type="radio" name="aksesFollow" value="N"> No</label>
                </div>
                <div class="hak-akses-item">
                <label>7. CRM :</label>
                    <label><input type="radio" name="aksesCRM" value="Y" checked> Yes</label>
                    <label><input type="radio" name="aksesCRM" value="N"> No</label>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-footer flex-column align-items-start">
        <!-- Notifikasi Pesan -->
        <div id="pesanNotifModalBox" class="notification-message w-100 mb-2" style="display: none;">
           <i id="pesanNotifModalIcon" class="pesan-notif-icon me-2"></i><span id="pesanNotifModalText"></span>
        </div>
        <!-- Tombol-tombol untuk Modal Add dan Edit -->
        <div class="w-100 d-flex justify-content-end gap-2">
            <button type="submit" class="btn btn-primary btn-sm" id="saveProdukBtn"><i class="fas fa-save"></i> Simpan</button>
            <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal"><i class="fas fa-close"></i> Batal</button>
        </div>
    </div>
</form>
</div>
</div>

<!-- Form Log Notifikasi -->
<div id="logNotifForm" class="container" style="display:none">
    <div class="title-box mb-3">
        <i class="fas fa-list-alt fa-lg"></i>
        <h6 class="mb-0">Log Notifikasi</h6>
    </div>

    <!-- Baris Tombol Filtere dan Aksi Form Log Notifikasi -->
    <div class="button-box d-flex justify-content-between align-items-center btn-group-vertical-responsive">    
        <div class="dropdown">
            <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="fas fa-filter"></i> Filter Status
            </button>
            <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="filterLogNotif('AKTIFASI')">Aktifasi</a></li>
                <li><a class="dropdown-item" href="#" onclick="filterLogNotif('TERESET')">Tereset</a></li>
                <li><a class="dropdown-item" href="#" onclick="filterLogNotif('TERKUNCI')">Terkunci</a></li>
                <li><a class="dropdown-item" href="#" onclick="filterLogNotif('SEMUA')">Semua</a></li>
            </ul>
        </div>
        <div>    
            <button class="btn btn-danger btn-sm mb-2" onclick="deleteAllLogNotif()">
                <i class="fas fa-trash"></i> Hapus Semua
            </button>
            <button class="btn btn-secondary btn-sm mb-2" onclick="kembaliKeSetupProduk()">
                <i class="fas fa-sign-out-alt"></i> Kembali
            </button>
        </div>
    </div>
    
    <!-- Pesan notifikasi -->
    <div id="pesanNotification" class="notification-message">
        <i id="pesanNotifIcon" class="pesan-notif-icon"></i><span id="pesanNotifText"></span>
    </div>
    
    <!-- Tabel Log Notifikasi -->
    <div class="table-box">
        <div class="table-wrapper">
            <table class="table table-hover table-striped table-bordered align-middle text-center">
                <thead class="sticky-header"><h6 class="mb-0">DAFTAR LOG Produk</h6>    
                <tr>
                    <th>Waktu</th>
                    <th>Produk ID</th>
                    <th>Nama</th>
                    <th>Email</th>
                    <th>No HP</th>
                    <th>Pass</th>
                    <th>Status</th>
                </tr>
                </thead>
                <!-- Loading Overlay -->
                <div id="loadingOverlayLog" class="loading-overlay" style="display:none; align-content: center ;">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
                <tbody id="logNotifTableBody" style="font-size: small;"><tr><td colspan="7">Memuat log notifikasi...</td></tr></tbody>
            </table>
        </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<SCRIPT>
// ********* Deklarasi  Public **********
const URL_APPS_SCRIPT = 'https://script.google.com/macros/s/AKfycbyAP7uDSqBVzB5IaK_Cp_ChGEq2eIR1Ehp70fY-ok9afD2Wytn_pStBwr0QLauNdDgW2A/exec';
// **************************************

// **********************************
// Tampilkan Spinner Loading Overlay
// **************************************
function showLoading(show, target = 'Produk') {
  const overlayId = target === 'log' ? 'loadingOverlayLog' : 'loadingOverlayProduk';
  const overlay = document.getElementById(overlayId);
  if (overlay) overlay.style.display = show ? 'flex' : 'none';
}

// *************************************
// Fungsi untuk load awal Tabel Produk id
// *************************************
document.addEventListener('DOMContentLoaded', loadProdukTable);
  document.getElementById('addProdukButton').addEventListener('click', () => {
  document.getElementById('mode').value = 'add';
  document.getElementById('ProdukForm').reset();
  document.getElementById('noStok').disabled = false;
  document.getElementById('judulModal').textContent = 'INPUT Produk';
  new bootstrap.Modal(document.getElementById('modalProduk')).show();
});

// **********************************
// Tambahkan sebelum loadProdukTable
// Untuk menghindari error atau tampilan karakter khusus di data dari sheet
// *********************************
function escapeHtml(text) {
  if (text === null || text === undefined) return '';
  return String(text)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/'/g, '&#39;')
    .replace(/"/g, '&quot;');
}

// *************************************
// Fungsi untuk memanggil Tabel Produk Id
// *************************************
function loadProdukTable() {
  showLoading(true, 'Produk');
  const callbackName = 'cb_' + Date.now();
  const script = document.createElement('script');
  script.src = `${URL_APPS_SCRIPT}?action=getTabelProduk&callback=${callbackName}`;

  window[callbackName] = function (data) {
    const tbody = document.getElementById('produkTableBody');
    tbody.innerHTML = '';

    if (!data || data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="11" class="text-center">Tidak ada data produk.</td></tr>';
      cleanup();
      showLoading(false, 'Produk');
      return;
    }

    data.forEach(row => {
        while (row.length < 10) row.push('');

        const [
            noStok, kategori, namaProduk, volumePoint, hargaDasar,
            hargaEceran, member25, sc35, sb42, spv50
        ] = row;

        const tr = document.createElement('tr');
        tr.id = `row_${noStok}`;
        tr.innerHTML = `
        <td class="text-start">${escapeHtml(noStok)}</td>
        <td class="text-start">${escapeHtml(kategori)}</td>
        <td class="text-start">${escapeHtml(namaProduk)}</td>
        <td class="text-end">${formatAngka(volumePoint, true)}</td> <!-- VP -->
        <td class="text-end">${formatAngka(hargaDasar)}</td>
        <td class="text-end">${formatAngka(hargaEceran)}</td>
        <td class="text-end">${formatAngka(member25)}</td>
        <td class="text-end">${formatAngka(sc35)}</td>
        <td class="text-end">${formatAngka(sb42)}</td>
        <td class="text-end">${formatAngka(spv50)}</td>
        <td class="actions-col text-center">
            <i class="fas fa-edit action-icon" title="Edit Produk" onclick="showEditModal({
            noStok: '${noStok}', kategori: '${kategori}', namaProduk: '${namaProduk}',
            volumePoint: '${volumePoint}', hargaDasar: '${hargaDasar}', hargaEceran: '${hargaEceran}',
            member25: '${member25}', sc35: '${sc35}', sb42: '${sb42}', spv50: '${spv50}'
            })"></i>
            <i class="fas fa-trash-alt action-icon" title="Hapus Produk" onclick="deleteProduk('${noStok}')"></i>
        </td>
        `;

        tbody.appendChild(tr);
    });

    cleanup();
    showLoading(false, 'Produk');
  };

  script.onerror = function () {
    showPesan('error', ' ERROR : Gagal mengambil data Produk!');
    cleanup();
    showLoading(false, 'Produk');
  };

  function cleanup() {
    try { delete window[callbackName]; } catch (e) {}
    if (script.parentNode) script.parentNode.removeChild(script);
  }

  document.body.appendChild(script);
}


// **********************************
// Fungsi untuk kembali ke setup Produk
// **********************************
function kembaliKeSetupProduk() {
  document.querySelector('.container').style.display    = 'block';  // Tampilkan semua form Setup Produk
  document.getElementById('logNotifForm').style.display = 'none';   // Sembunyikan form Log Notifikasi
  loadProdukTable(); // Refresh data Produk
}

// ********************************************
// Fungsi untuk memanggil Tabel Log Notifikasi 
// ********************************************
function loadLogNotifTable() {
  showLoading(true, 'log');
  const callbackName = 'cb_' + Date.now();
  const script       = document.createElement('script');
  script.src         = `${URL_APPS_SCRIPT}?action=getLogNotif&callback=${callbackName}`;

  window[callbackName] = function(data) {
    const tbody = document.getElementById('logNotifTableBody');
    tbody.innerHTML = '';

    if (!data || data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7">Tidak ada log notifikasi.</td></tr>';
      showLoading(false, 'log');
      return;
    }

    data.forEach(row => {
      const [waktu, noStok, nama, email, hp, pass, status] = row;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${waktu}</td>
        <td>${noStok}</td>
        <td>${nama}</td>
        <td>${email}</td>
        <td>${hp}</td>
        <td>${pass}</td>
        <td>${status}</td>
      `;
      tbody.appendChild(tr);
    });
    showLoading(false, 'log');
    delete window[callbackName];
    document.body.removeChild(script);
  };

  script.onerror = function() {
    showPesan('error', ' ERROR : Gagal mengambil data log notifikasi!');
    showLoading(true, 'log');
    delete window[callbackName];
    document.body.removeChild(script);
  };

  document.body.appendChild(script);
}

// ***************************************************
// Sembunyikan tombol Setup Produk saat tampil Log Notif
// ***************************************************
function showLogNotifForm() {
  // Sembunyikan elemen-elemen Setup Produk
  document.querySelector('.container').style.display    = 'none';  // Sembunyikan semua form Setup Produk
  document.getElementById('logNotifForm').style.display = 'block'; // Tampilkan form Log Notifikasi
  loadLogNotifTable(); // Load datanya
}

// **************************
// Fungsi untuk menambah Produk
// **************************
function addProduk() {
    const nomorStok  = document.getElementById('noStok').value.trim().toLowerCase();
    document.getElementById('noStok').value = nomorStok;
    const namaProduk = document.getElementById('produkName').value.trim().toUpperCase();
    document.getElementById('produkName').value = namaProduk;
    const volumePoint= document.getElementById('volumePoint').value = volumePoint;
    const hargaDasar = document.getElementById('hargaDasar').value = hargaDasar;
    const hargaEceran = document.getElementById('hargaEceran').value = hargaEceran;
    const member25 = document.getElementById('member25').value = member25;
    const sc35 = document.getElementById('sc35').value = sc35;
    const sb42 = document.getElementById('sb42').value = sb42;
    const spv50 = document.getElementById('spv50').value = spv50;
    
    // Validasi
    if (!validateProdukForm()) return;

    // Cek duplikasi Produk ID di tabel
    const rows = document.querySelectorAll('#produkTableBody tr');
    for (let row of rows) {
        const cellnoStok = row.children[0]?.textContent?.trim();
        if (cellnoStok === noStok) {
            showPesanModal("warning", " WARNING : Produk ID sudah digunakan.");
            return;
        }
    }

    const callbackName = 'cb_' + Date.now();
    window[callbackName] = function(response) {
        if (response.success) {
            showPesanModal('success', ' SUKSES : ' + response.message);
            bootstrap.Modal.getInstance(document.getElementById("modalProduk")).hide();
            loadProdukTable();
        } else {
            showPesanModal('error', ' ERROR : Gagal menyimpan data');
        }
        delete window[callbackName];
    };

    const params = new URLSearchParams({
        action: 'addProduk',
        noStok, produkName, volumePoint, hargaDasar, hargaEceran,
        member25, sc35, sb42, spv50,
        callback: callbackName
    });

    const script = document.createElement('script');
    script.src = `${URL_APPS_SCRIPT}?${params.toString()}`;
    document.body.appendChild(script);
}

// *******************************
// Fungsi untuk mengedit Produk id
// *******************************
function editProduk() {
    const nomorStok  = document.getElementById('noStok').value.trim().toLowerCase();
    document.getElementById('noStok').value = nomorStok;
    const namaProduk = document.getElementById('produkName').value.trim().toUpperCase();
    document.getElementById('produkName').value = namaProduk;
    const volumePoint= document.getElementById('volumePoint').value.trim();
    const hargaDasar = document.getElementById('hargaDasar').value.trim();
    const hargaEceran = document.getElementById('hargaEceran').value.trim();
    const member25 = document.getElementById('member25').value.trim();
    const sc35 = document.getElementById('sc35').value.trim();
    const sb42 = document.getElementById('sb42').value.trim();
    const spv50 = document.getElementById('spv50').value.trim();

    // Validasi
    if (!validateProdukForm()) return;

    const callbackName = 'cb_' + Date.now();
    window[callbackName] = function(res) {
        if (res.status === "success") {
            showPesanModal("success", " SUKSES : " + res.message);
            bootstrap.Modal.getInstance(document.getElementById("modalProduk")).hide();
            loadProdukTable();
            document.getElementById("modalProduk").setAttribute("data-mode", "add");
        } else {
            showPesanModal("error", " ERROR : " + res.message);
        }
        delete window[callbackName];
    };

    const params = new URLSearchParams({
        action: 'editProduk',
        noStok, produkName, volumePoint, hargaDasar, hargaEceran,
        member25, sc35, sb42, spv50,
        callback: callbackName
    });

    const script = document.createElement("script");
    script.src = `${URL_APPS_SCRIPT}?${params.toString()}`;
    document.body.appendChild(script);
}

// **************************************
// Fungsi untuk pengaturan tombol simpan
// **************************************
document.addEventListener('DOMContentLoaded', () => {
  const saveBtn = document.getElementById("saveProdukBtn");
  if (saveBtn) {
    saveBtn.addEventListener("click", (e) => {
      e.preventDefault();
      const mode = document.getElementById("modalProduk").getAttribute("data-mode");
      if (mode === "edit") {
        editProduk();
      } else {
        addProduk();
      }
    });
  }
});

// ******************************
// Fungsi untuk menghapus Produk id
// ******************************
function deleteProduk(noStok) {
  if (!confirm("Yakin ingin menghapus Produk ini?")) return;

  const callback = 'cb_' + Date.now();
  window[callback] = function(response) {
    if (response.status === 'success') {
       showPesan('success', " SUKSES : " + response.message);
       loadProdukTable(); // Refresh tabel
    }
    delete window[callback];
  };

  const script = document.createElement('script');
  script.src = `${URL_APPS_SCRIPT}?action=deleteProduk&noStok=${encodeURIComponent(noStok)}&callback=${callback}`;
  document.body.appendChild(script);
}

// **********************
// Mengupdate Baris Icon
// *********************
function updateRowIcons(row, mode) {
    const icons = row.querySelectorAll('.action-icon');
    const [editIcon, aktifasiIcon, delIcon, unlockIcon, kirimIcon] = icons;

    if (mode === 'unlock') {
        editIcon.classList.add('disabled');
        delIcon.classList.add('disabled');
    } else if (mode === 'kirim') {
        editIcon.classList.remove('disabled');
        delIcon.classList.remove('disabled');
    }
}

// ********************************
// Menghapus Seluruh log Notifikasi
// ********************************
function deleteAllLogNotif() {
  if (!confirm("Yakin ingin menghapus semua log notifikasi?")) return;

  const callback = 'cb_' + Date.now();
  const script   = document.createElement('script');
  script.src     = `${URL_APPS_SCRIPT}?action=deleteAllLogNotif&callback=${callback}`;

  window[callback] = function(response) {
    if (response.status === 'success') {
      showPesan("success", "Semua log berhasil dihapus");
      loadLogNotifTable(); // Refresh tabel log
    } else {
      showPesan("error", "Gagal menghapus log");
    }
    delete window[callback];
    document.body.removeChild(script);
  };

  script.onerror = function() {
    showPesan("error", "Tidak dapat terhubung ke server");
    delete window[callback];
    document.body.removeChild(script);
  };

  document.body.appendChild(script);
}

// *****************************************
// Pesan Notifikasi untuk di Form Tabel Produk
// *****************************************
function showPesan(type, message, duration = 3000) {
  const box      = document.getElementById('pesanNotification');
  const icon     = document.getElementById('pesanNotifIcon');
  const text     = document.getElementById('pesanNotifText');

  // Reset class
  box.className  = 'notification-message';
  icon.className = 'pesan-notif-icon';

  if (type === 'error') {
    box.classList.add('notification-error');
    icon.classList.add('fas', 'fa-times-circle');
  } else if (type === 'success') {
    box.classList.add('notification-success');
    icon.classList.add('fas', 'fa-check-circle');
  } else if (type === 'warning') {
    box.classList.add('notification-warning');
    icon.classList.add('fas', 'fa-exclamation-circle');
  }
  text.textContent  = message;
  box.style.display = 'flex';
  setTimeout(() => {box.style.display = 'none';}, duration);
}

// **************************************************
// Pesan Notifikasi untuk di Form Modal Add dan Edit
// **************************************************
function showPesanModal(type, message, duration = 3000) {
  const boxModal  = document.getElementById('pesanNotifModalBox');
  const iconModal = document.getElementById('pesanNotifModalIcon');
  const textModal = document.getElementById('pesanNotifModalText');

  // Reset class
  boxModal.className  = 'notification-message w-100 mb-2';
  iconModal.className = 'pesan-notif-icon me-2';

  if (type === 'error') {
    boxModal.classList.add('notification-error');
    iconModal.classList.add('fas', 'fa-times-circle');
  } else if (type === 'success') {
    boxModal.classList.add('notification-success');
    iconModal.classList.add('fas', 'fa-check-circle');
  } else if (type === 'warning') {
    boxModal.classList.add('notification-warning');
    iconModal.classList.add('fas', 'fa-exclamation-circle');
  }

  textModal.textContent  = message;
  boxModal.style.display = 'flex';
  setTimeout(() => {
    boxModal.style.display = 'none';
  }, duration);
}


// **************************
// Tampilkan Modal Edit Produk
// ************************** 
function showEditModal(ProdukData) {
  // Isi input dari ProdukData
  document.getElementById('judulModal').textContent = 'EDIT Produk';
  document.getElementById('noStok').disabled = true;
  document.getElementById("noStok").value    = ProdukData.noStok;
  document.getElementById("ProdukName").value  = ProdukData.ProdukName;
  document.getElementById("ProdukEmail").value = ProdukData.ProdukEmail;
  document.getElementById("ProdukHP").value    = ProdukData.ProdukHP;
  document.getElementById("ProdukPass").value  = ProdukData.ProdukPass;
  document.getElementById("ProdukLevel").value = ProdukData.ProdukLevel;

  // Set radio akses
  const akses = ['Login','Setting','FLC','EstiH','WE','Followup','CRM'];
  akses.forEach(aksesName => {
    const val   = ProdukData['akses'+aksesName] || 'N';
    const radio = document.querySelector(`input[name="akses${aksesName}"][value="${val}"]`);
    if (radio) radio.checked = true;
  });

  // Tampilkan modal & ubah mode
  document.getElementById("modalProduk").setAttribute("data-mode", "edit");
  new bootstrap.Modal(document.getElementById("modalProduk")).show();
}

// **********************
// Validasi Form Produk
// ********************** 
function validateProdukForm() {
    const noStok    = document.getElementById('noStok').value.trim().toLowerCase();
    document.getElementById('noStok').value = noStok;
    const ProdukName  = document.getElementById('ProdukName').value.trim().toUpperCase();
    document.getElementById('ProdukName').value = ProdukName;

    const ProdukEmail = document.getElementById('ProdukEmail').value.trim();
    const ProdukHP    = document.getElementById('ProdukHP').value.trim();
    const ProdukPass  = document.getElementById('ProdukPass').value.trim();

    const noStokPattern   = /^[a-z0-9]{6,8}$/;                       // hanya huruf kecil & angka, panjang 6â€“8
    const ProdukNamePattern = /^[A-Z\s]{3,20}$/;                       // hanya huruf besar & angka, panjang 3â€“20
    const emailPattern    = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    const hpPattern       = /^[0-9]{10,14}$/;                        // hanya angka, panjang 10â€“14
    const passwordPattern = /^[a-zA-Z0-9!@#$%^&*()_+=\-{}[\]:;"'<>,.?/\\]{6,8}$/;

    if (!noStokPattern.test(noStok)) {
        showPesanModal("warning", " WARNING : Produk ID huruf kecil/angka 6-8 karakter.");
        return false;
    }
    if (!ProdukNamePattern.test(ProdukName)) {
        showPesanModal("warning", " WARNING : Nama huruf besar dan 3-20 karakter.");
        return false;
    }
    if (!emailPattern.test(ProdukEmail)) {
        showPesanModal("warning", " WARNING : Format email tidak valid.");
        return false;
    }
    if (!hpPattern.test(ProdukHP)) {
        showPesanModal("warning", " WARNING : Nomor HP harus 10-14 digit angka.");
        return false;
    }
    if (!passwordPattern.test(ProdukPass)) {
        showPesanModal("warning", " WARNING : Pass 6-8 karakter kombinasi huruf,angka,simbol.");
        return false;
    }
    return true;
}

// *****************************
// Filter Log Notifikasi
// *****************************   
function filterLogNotif(status) {
    const rows = document.querySelectorAll('#logNotifTableBody tr');
    rows.forEach(row => {
        const statusText = row.cells[6]?.textContent?.trim().toUpperCase();
        if (status === 'SEMUA' || statusText === status.toUpperCase()) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// Format angka sesuai lokal Indonesia (selalu 2 desimal, koma sebagai pemisah)
function formatAngka(value, isVP = false) {
  if (value === null || value === undefined || value === '') return '';

  let num;
  if (isVP) {
    // VP hanya punya koma desimal, tidak ada pemisah ribuan
    num = parseFloat(value.toString().replace(',', '.'));
  } else {
    // Harga/harga lain: hapus titik (ribuan), ganti koma dengan titik (desimal)
    num = parseFloat(value.toString().replace(/\./g, '').replace(',', '.'));
  }

  if (isNaN(num)) return '';

  return new Intl.NumberFormat("id-ID", {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  }).format(num);
}


</SCRIPT>
</body>
</html>